# ‚úÖ Supabase Storage Setup Complete

## üéØ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Supabase Storage –¥–ª—è —Ñ–∞–π–ª–æ–≤ –¥–æ–≥–æ–≤–æ—Ä–æ–≤

**–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**: –Ø–Ω–≤–∞—Ä—å 2025  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–í–ï–†–®–ï–ù–û**

---

## üìã –ß—Ç–æ –±—ã–ª–æ —Å–æ–∑–¥–∞–Ω–æ

### 1. **Supabase Storage Bucket**
```sql
-- Bucket –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –¥–æ–≥–æ–≤–æ—Ä–æ–≤
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types) 
VALUES (
  'contracts', 
  'contracts', 
  false, 
  52428800, -- 50MB
  ARRAY['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document']
);
```

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ bucket**:
- üÜî **ID**: `contracts`
- üîí **–ü—Ä–∏–≤–∞—Ç–Ω—ã–π**: `public: false`
- üìè **–õ–∏–º–∏—Ç —Ä–∞–∑–º–µ—Ä–∞**: 50MB (52,428,800 –±–∞–π—Ç)
- üìÑ **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã**: PDF, DOC, DOCX

### 2. **Row Level Security (RLS) –ü–æ–ª–∏—Ç–∏–∫–∏**

#### **–ü–æ–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–∞–π–ª–æ–≤**
```sql
CREATE POLICY "Users can view own contract files" ON storage.objects
FOR SELECT USING (
  bucket_id = 'contracts' AND 
  auth.uid()::text = (storage.foldername(name))[1]
);
```

#### **–ü–æ–ª–∏—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤**
```sql
CREATE POLICY "Users can upload contract files" ON storage.objects
FOR INSERT WITH CHECK (
  bucket_id = 'contracts' AND 
  auth.uid()::text = (storage.foldername(name))[1]
);
```

#### **–ü–æ–ª–∏—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤**
```sql
CREATE POLICY "Users can update own contract files" ON storage.objects
FOR UPDATE USING (
  bucket_id = 'contracts' AND 
  auth.uid()::text = (storage.foldername(name))[1]
);
```

#### **–ü–æ–ª–∏—Ç–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤**
```sql
CREATE POLICY "Users can delete own contract files" ON storage.objects
FOR DELETE USING (
  bucket_id = 'contracts' AND 
  auth.uid()::text = (storage.foldername(name))[1]
);
```

### 3. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤**
```
contracts/
‚îú‚îÄ‚îÄ {userId}/
‚îÇ   ‚îú‚îÄ‚îÄ {timestamp}_{randomString}_{filename}.pdf
‚îÇ   ‚îú‚îÄ‚îÄ {timestamp}_{randomString}_{filename}.doc
‚îÇ   ‚îî‚îÄ‚îÄ {timestamp}_{randomString}_{filename}.docx
‚îî‚îÄ‚îÄ ...
```

**–ü—Ä–∏–Ω—Ü–∏–ø—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏**:
- üîê **–ò–∑–æ–ª—è—Ü–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º**: –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Å–≤–æ—é –ø–∞–ø–∫—É
- üïê **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞**: timestamp + random string –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç –∫–æ–ª–ª–∏–∑–∏–∏
- üìÅ **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –∏–º–µ–Ω**: –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### **–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç**: `scripts/test-storage-setup.js`

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**:
- ‚úÖ **CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω**: OPTIONS /api/contracts/upload ‚Üí 200
- ‚úÖ **API endpoints –¥–æ—Å—Ç—É–ø–Ω—ã**: GET /api/contracts ‚Üí 401 (—Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)
- ‚úÖ **Upload endpoint –∑–∞—â–∏—â–µ–Ω**: POST /api/contracts/upload ‚Üí 401 (—Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)
- ‚úÖ **File validation —Ä–∞–±–æ—Ç–∞–µ—Ç**: —Ç–µ—Å—Ç–æ–≤—ã–π PDF —Ñ–∞–π–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è

### **–ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**:
```bash
# –¢–µ—Å—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Storage
node scripts/test-storage-setup.js

# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏)
npm run build

# –ó–∞–ø—É—Å–∫ dev —Å–µ—Ä–≤–µ—Ä–∞
npm run dev
```

---

## üîß –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

### **Backend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞**:
- ‚úÖ `lib/services/file-upload-service.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç bucket `contracts`
- ‚úÖ `app/api/contracts/upload/route.ts` - endpoint –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
- ‚úÖ `utils/contract-validation.ts` - –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤
- ‚úÖ `types/contract.ts` - —Ç–∏–ø—ã –¥–ª—è —Ñ–∞–π–ª–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

### **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**:
```bash
# Supabase Configuration (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã)
NEXT_PUBLIC_SUPABASE_URL=https://dqlnpldlbdtwurxggmoa.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=***
SUPABASE_SERVICE_ROLE_KEY=***
```

---

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### **‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–æ**:
1. **Storage bucket —Å–æ–∑–¥–∞–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω**
2. **RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
3. **API endpoints –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç**
4. **File upload —Å–∏—Å—Ç–µ–º–∞ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞**
5. **CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è frontend –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è**

### **üìã TODO.md –æ–±–Ω–æ–≤–ª–µ–Ω**:
- ‚úÖ **–ó–∞–¥–∞—á–∞ 2.5** –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è
- ‚úÖ **–ó–∞–¥–∞—á–∞ 15** –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è
- ‚úÖ **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏** –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å —É—á–µ—Ç–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MCP**
–ó–∞–º–µ–Ω–∏—Ç—å —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ `lib/repositories/contract-repository.ts` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã Supabase MCP —Ñ—É–Ω–∫—Ü–∏–π.

### **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**
–ü–µ—Ä–µ–π—Ç–∏ –∫ **–ó–∞–¥–∞—á–µ 16**: —Å–æ–∑–¥–∞–Ω–∏–µ React hooks –∏ API –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–æ–≥–æ–≤–æ—Ä–∞–º–∏.

### **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**
–ü–µ—Ä–µ–π—Ç–∏ –∫ **–ó–∞–¥–∞—á–µ 17**: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞–º–∏ —á–µ—Ä–µ–∑ MCP.

---

## üí° –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**Supabase Storage –¥–ª—è —Ñ–∞–π–ª–æ–≤ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é**. –°–∏—Å—Ç–µ–º–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

- üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –∑–∞—â–∏—â–∞—é—Ç —Ñ–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚ö° **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è
- üõ°Ô∏è **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –∏ error handling
- üîß **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–æ—Å—Ç—É –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ**: –û—Ç–∫–∞–∑ –æ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–æ–≤–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ø–æ–ª—å–∑—É Supabase Storage –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç serverless –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ —É–ø—Ä–æ—â–∞–µ—Ç deployment –Ω–∞ Vercel. 